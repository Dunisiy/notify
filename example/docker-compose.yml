version: "3.8"
networks:
  lan:
services:
  registrator:
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    build:
      context: registrator
      network: host
    container_name: reg
    networks:
      - lan
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://reg:9090/health" ]
      interval: 5s
      timeout: 2s
      retries: 10
  nodes:
    build: .
    ports:
      - "9030-9045:5050"
    depends_on:
      registrator:
        condition: service_healthy
    networks:
      - lan
  api:
    networks:
      - lan
    depends_on:
      registrator:
        condition: service_healthy
    build: api
    ports:
    - "8888:8888"